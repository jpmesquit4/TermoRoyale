<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jogo da Carta</title>
    <link rel="stylesheet" href="index.css">
</head>
<body>

    <main>

        <header>

            <div class="left">
                <h1>termo royale<span>.</span></h1>
            </div>

            <div class="center">
                    <a href="/index.html">ClÃ¡ssico</a>
                    <a href="/pages/carta/index.html">Carta</a>
                    <a href="/pages/regras/index.html" target="_blank">Como jogar</a>
            </div>

            <div class="right">
                <p></p>
            </div>

        </header>

        <div class="menu-center">
            <div>

        </div>

        <div id="meio">
            <div id="cartaSorteadaImg"></div>

            <div class="input-wrapper">
                <input id="nomeCarta" autocomplete="off" type="text" placeholder="Digite o nome da carta"
                    onkeydown="if(event.key==='Enter'){jogar()}">

                <button onclick="jogar()" class="search-icon">
                    <img src="/images/lupa.png" alt="">
                </button>
            </div>

            <div id="tentativas"></div>
        </div>

        <div class="dicas">
            <h1>Dicas</h1>
            <div id="infoRaridade"></div>
            <div id="infoElixir"></div>
        </div>
        </div>

        <div id="popup" class="popup hidden">
            <div class="popup-content">
                <h2 id="popupTitle"></h2>
                <p id="popupText"></p>
                <button onclick="fecharPopup()">OK</button>
                <button id="btnReload" class="hidden" onclick="window.location.reload(true)">Tentar novamente</button>
            </div>
        </div>
        
    </main>

    <script src="/pull.js"></script>

    <script>
        let jogoFinalizado = false;
        let resposta;
        let tentativas = 0;

        let cartasTentadas = [];

        function normalizar(str) {
            return str
            .normalize("NFD")
            .replace(/\p{Diacritic}/gu, "") // remove acentos
            .replace(/[^a-z0-9]/gi, "")      // remove tudo que nÃ£o Ã© letra/nÃºmero
            .toLowerCase()
            .trim();
        }

        window.onload = function () {
            const total = allCards.items.length;
            resposta = allCards.items[Math.floor(Math.random() * total)];
            document.getElementById("cartaSorteadaImg").style.backgroundImage =
            `url('${resposta.iconUrls.medium}')`;
        };

        function jogar() {
            if (jogoFinalizado) return;

            const entrada = document.getElementById("nomeCarta").value.trim();
            if (!entrada) return;

            const entradaNormalizada = normalizar(entrada);

            const carta = allCards.items.find(c => {
                const nomeCarta = normalizar(c.name);

                // Caso especial: O Tronco
                if (nomeCarta === "otronco" && entradaNormalizada === "tronco") {
                    return true;
                }

                return nomeCarta === entradaNormalizada;
            });


            if (!carta) {
                mostrarPopup(
                    "Carta invÃ¡lida",
                    "Essa carta nÃ£o existe. Verifique o nome e tente novamente.",
                    "erro"
                );
                return;
            }

            registrarTentativa(carta);
            document.getElementById("nomeCarta").value = "";
        }

        function registrarTentativa(carta) {

            // Verifica se jÃ¡ tentou essa carta
const similares = calcularSimilaridade(carta, resposta);

cartasTentadas.push({
    carta,
    similares,
    score: similares.length // usado para ordenaÃ§Ã£o
});



            tentativas++;

            // Revelar raridade na 2Âª tentativa
            if (tentativas === 2) {
            const raridade = document.getElementById("infoRaridade");
            raridade.style.display = "block";
            raridade.innerText = "Raridade: " + resposta.rarity;
            }

        // 5Âª tentativa â†’ elixir
        if (tentativas === 5) {
            const elixir = document.getElementById("infoElixir");
            elixir.style.display = "block";
            elixir.innerText = "Custo de Elixir: " + resposta.elixirCost;
        }

    renderizarTentativas();

    ajustarBlur();

    if (carta.id === resposta.id) {
        jogoFinalizado = true;
        document.getElementById("cartaSorteadaImg").style.filter = "none";



        mostrarPopup(
        "VitÃ³ria!",
        `ParabÃ©ns! VocÃª acertou a carta em ${tentativas} tentativas.`,
        "vitoria"
    );
    }
}


        function ajustarBlur() {
    const img = document.getElementById("cartaSorteadaImg");

    // Antes de 10 tentativas, nÃ£o muda nada
    if (tentativas < 10) {
        img.style.filter = "grayscale(100%) blur(30px)";
        return;
    }

    // ApÃ³s 10 tentativas, comeÃ§a a reduzir
    const tentativasApos10 = tentativas - 10;

    // A cada 2 tentativas = 1 etapa
    const etapas = Math.floor(tentativasApos10 / 2);

    // Diminui 20% de grayscale e 2px de blur por etapa
    const grayscale = Math.max(100 - etapas * 8, 0);
    const blur = Math.max(18 - etapas * 1, 6);

    img.style.filter = `grayscale(${grayscale}%) blur(${blur}px)`;
}

    function mostrarPopup(titulo = "", texto = "", tipo = "erro") {
        const popup = document.getElementById("popup");
        const content = popup.querySelector(".popup-content");
        const btnReload = document.getElementById("btnReload");

        // RESET TOTAL
        btnReload.classList.add("hidden");
        btnReload.style.display = "none";

        document.getElementById("popupTitle").innerText = titulo;
        document.getElementById("popupText").innerText = texto;

        content.classList.remove("erro", "vitoria");
        content.classList.add(tipo);

        if (tipo === "vitoria") {
            btnReload.classList.remove("hidden");
            btnReload.style.display = "inline-flex";
        }

        popup.classList.remove("hidden");
    }





function fecharPopup() {
    document.getElementById("popup").classList.add("hidden");
}



    function calcularSimilaridade(carta, resposta) {
    const similares = [];

    // Primeira letra
    if (normalizar(carta.name)[0] === normalizar(resposta.name)[0]) {
        similares.push("âœï¸");
    }

    // Elixir
    if (carta.elixirCost === resposta.elixirCost) {
        similares.push("âš—ï¸");
    }

    // Raridade
    if (carta.rarity === resposta.rarity) {
        similares.push("ðŸ’Ž");
    }

    return similares;
}


function renderizarTentativas() {
    const container = document.getElementById("tentativas");
    container.innerHTML = "";

    // Mais Ã­cones = mais parecido = sobe
    cartasTentadas.sort((a, b) => b.score - a.score);

    cartasTentadas.forEach(item => {
        const div = document.createElement("div");
        div.classList.add("linha");

        const icones = item.similares.join("");

        div.innerHTML = `
            <span class="nome-carta">${item.carta.name}</span>
            <span class="icones">${icones}</span>
        `;

        container.appendChild(div);
    });
}


    

    </script>

</body>
</html>
